import React, { useEffect, useState } from "react";
import { useAuth0 } from "@auth0/auth0-react";
import { IUserMetadata } from "../interfaces/IUserMetadata";
import Orders from "../components/Orders";
import LoadingBar from "../components/LoadingBar";

const Profile = () => {
  const { user, isAuthenticated, getAccessTokenWithPopup, getAccessTokenSilently } = useAuth0();
  const [userMetadata, setUserMetadata] = useState<IUserMetadata | null>(null);


  useEffect(() => {
    const getUserMetadata = async () => {
      const domain = "dev-4qy3uxvn.us.auth0.com";
      console.log( await getAccessTokenSilently());
      try {
        const accessToken = await getAccessTokenWithPopup({
          audience: `https://${domain}/api/v2/`,
          scope: "read:current_user update:current_user_metadata buy:products",
        }, {
          popup: window.open("http://localhost:5173")
        });

        const userDetailsByIdUrl = `https://${domain}/api/v2/users/${user?.sub}`;

        const metadataResponse = await fetch(userDetailsByIdUrl, {
          headers: {
            Authorization: `Bearer ${accessToken}`,
          },
        });

        const { user_metadata } = await metadataResponse.json();

        setUserMetadata(user_metadata);
      } catch (e: any) {
        console.log(e.message);
      }
    };

    getUserMetadata();
  }, [getAccessTokenWithPopup, user?.sub]);
  //&& userMetadata.addresses && userMetadata.favorite_beer
  if(userMetadata){
    return (
      <section className="bg-white flex flex-col space-y-2 items-center justify-center w-full p-2">
        <div className="bg-zinc-50 my-32 md:my-40 lg:mt-64 flex justify-start items-start flex-row p-4 md:p-12 rounded-md border-2 border-t-zinc-200 shadow-lg ">
          <div className="my-4" >
            <img className="rounded-md w-16 h-16 lg:w-28 lg:h-28" src={user?.picture} alt={user?.name} />
          </div>
          <div className="flex flex-col items-start justify-center mt-4 ml-16">
          <p className="text-sm md:text-lg">
            <span className="font-bold mr-8">Email:</span> {user?.email}
          </p>
          <p className="text-sm md:text-lg">
            <span className="font-bold mr-2">Berea favorita:</span> {userMetadata?.favorite_beer}
          </p>
          <p className="text-sm md:text-lg">
            <span className="font-bold mr-2 lg:mr-6">Adresa:</span> {userMetadata?.addresses.home_address}
          </p>
          <p className="text-sm md:text-lg">
            <span className="font-bold mr-2 lg:mr-6">Telefon:</span> {userMetadata?.phone}
          </p>
          </div>
        </div>
        <Orders/>
      </section>
    
    );
  }

  return (
    // <section className="flex items-center justify-center py-20 md:py-40 mx-8">
    //     <p className="font-semibold text-xl"></p>
    // </section>
    <LoadingBar/>
  )

  
};

export default Profile;